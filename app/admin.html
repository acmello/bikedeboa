<!doctype html>

<html lang="pt-br">
    <head>
        <meta charset="UTF-8">
        <title>admin</title>

        <!-- CSS -->
        <link rel="stylesheet" type="text/css" href="../dist/css/vendors.min.css"/>
        <!-- <link rel="stylesheet" type="text/css" href="../dist/css/main.css"/> -->

        <!-- Google Fonts (async) -->
        <link async href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet">
        <link async href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">

        <!-- Google Maps API -->
        <!-- <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD6TeLzQCvWopEQ7hBdbktYsmYI9aNjFc8&libraries=places&language=pt-BR" type="text/javascript"></script> -->

        <!-- JS -->
        <script src="../dist/js/vendors.min.js"></script>
        <script src="../dist/js/app.min.js"></script>

        <!-- Bootstrap Extended Tables -->
        <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.11.0/bootstrap-table.min.css">
        <script src="http://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.11.0/bootstrap-table.min.js"></script>

        <!-- Extensions -->
        <!-- editable -->
        <script src="https://rawgit.com/vitalets/x-editable/master/dist/bootstrap3-editable/js/bootstrap-editable.js"></script>
        <link rel="stylesheet" href="https://rawgit.com/vitalets/x-editable/master/dist/bootstrap3-editable/css/bootstrap-editable.css">
        <script src="../public/lib/bootstrap-table-extensions/editable/bootstrap-table-editable.js"></script>
        <!-- export -->
        <script src="../public/lib/bootstrap-table-extensions/export/bootstrap-table-export.js"></script>
        <!-- mobile -->
        <script src="../public/lib/bootstrap-table-extensions/mobile/bootstrap-table-mobile.js"></script>
        <!-- sticky-header -->
        <script src="../public/lib/bootstrap-table-extensions/sticky-header/bootstrap-table-sticky-header.js"></script>
        <link rel="stylesheet" href="../public/lib/bootstrap-table-extensions/sticky-header/bootstrap-table-sticky-header.css">

        <style>
          body {
            font-family: "Roboto", Arial, sans-serif;
            margin-top: 100px;
          }

          tbody > tr:not(.detail-view) {
            cursor: pointer;
          }

          tbody > tr:hover:not(.detail-view) {
            background-color: #f5f5f5;
          }

          th, .col-title {
            font-family: 'Raleway', sans-serif;
          }

          td,
          td a.editable-pre-wrapped {
            max-width: 100px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
          }

          .editable-empty {
            color: #E9BB2B;
          }

          th {
            text-align: center;
          }

          .col-reviews {
            max-width: 70px;
          }

          .col-title {
            max-width: 150px;
          }
          td.col-title {
            font-size: 1.2em;
            font-weight: 600;
          }

          td.col-timestamp,
          td.col-description,
          td.col-address {
            font-size: 0.8em;
          }
 
          .col-id {
            width: 60px;
            color: gray;
          }

          .details-view img {
            float: right;
            max-height: 600px;
          }


        </style>
    </head>

    <body>

      <h2 id="heading1">
        Carregando usuários...
      </h2>

      <table
        id="usersTable"
        data-classes="table table-no-bordered"
        data-striped="true"
        data-search="true"
        data-show-toggle="true"
        data-show-columns="true"
        data-show-footer="false"
        data-sticky-header="true">
      </table> 

      <h2 id="heading2">
        Carregando bicicletários...
      </h2>

      <table
        id="localsTable"
        data-classes="table table-no-bordered"
        data-striped="true"
        data-search="true"
        data-show-refresh="true"
        data-show-toggle="true"
        data-show-columns="true"
        data-show-export="true"
        data-detail-view="true"
        data-detail-formatter="detailFormatter"
        data-row-style="rowStyle"
        data-show-footer="false"
        data-sticky-header="true">
      </table> 

      <script>
        function detailFormatter(index, row) {
          var html = '';
          
          html += '<div class="details-view">';

          if (row.photo) {
            html += `<img src='${row.photo}'></img>`;
          }

          html += '<iframe width="500" height="250" style="float: right;" frameborder="0" scrolling="no" marginheight="0" marginwidth="0" src="https://maps.google.com/maps?q='+row.lat+','+row.lng+'&hl=es;z=14&amp;output=embed"></iframe>';

          $.each(row, function (key, value) {
            if (key !== 'photo') {
              html += '<span><b>' + key + ':</b> ' + value + '</span><br>';
            }
          });
          
          html += '</div>';
          
          return html;
        }

        function rowStyle(row, index) {
          // const classes = ['active', 'success', 'info', 'warning', 'danger'];
          if (row.text && row.text.length > 0 &&
              row.structureType != null &&
              row.isPublic != null) {
            return {
              // classes: 'success'
            };
          } else {
            return {
              // classes: 'warning'
            };
          }
        }

        // function photoColFormatter(value) {
        //   return value ? 'Sim' : '-';
        // }

        function timestampColFormatter(value) {
          return value && new Date(value).toUTCString();
        }

        function updateTable() {
          let structureTypes = [];
          for(let i=0; i < STRUCTURE_NAMES.length; i++) {
            structureTypes.push({value: STRUCTURE_CODES[i], text: STRUCTURE_NAMES[i]});
          }

          // Massage data for BootstrapTable
          markers.forEach( m => {
            if (m.isPublic === true) {
              m.isPublic = 1;
            } else if (m.isPublic === false) {
              m.isPublic = 0;
            }
          });

          $('#localsTable').bootstrapTable({
            columns: [
              {
                field: 'updatedAt', title: 'Modificado em', sortable: true, class: 'col-timestamp', formatter: 'timestampColFormatter'
              },
              {
                field: 'id', title: 'ID', sortable: true, class: 'col-id',
              },
              {
                field: 'text', title: 'Titulo', sortable: true, class: 'col-title',
                  editable: true
              },
              {
                field: 'address', title: 'Endereço', sortable: true, class: 'col-address',
                  editable: true, 'editable-type': 'textarea'
              },
              {
                field: 'lat', title: 'lat', sortable: true, visible: false,
              },
              {
                field: 'lng', title: 'lng', sortable: true, visible: false,
              },
              {
                field: 'isPublic', title: 'Público?', sortable: true,
                  editable: true, 'editable-type': 'select', 'editable-source': "[{'value': '1', 'text': 'Publico'}, {'value': '0', 'text': 'Exclusivo'} ]"
              },
              {
                field: 'structureType', title: 'Tipo', sortable: true,
                  editable: true, 'editable-type': 'select', 'editable-source': JSON.stringify(structureTypes).replace(/\"/g, '\'')
              },
              {
                field: 'average', title: 'Média', sortable: true, visible: false, 
              },
              {
                field: 'reviews', title: 'Avaliações', sortable: true, class: 'col-reviews'
              },
              {
                field: 'checkins', title: 'Check-ins',sortable: true, visible: false,
              },
              {
                field: 'description', title: 'Descrição', sortable: true, class: 'col-description',
                  editable: true, 'editable-type': 'textarea'
              },
              {
                field: 'photo', title: 'Foto', sortable: true,
                  editable: true
              }
            ],
            data: markers,
            sortName: 'updatedAt', sortOrder: 'desc'
          });
        }

        function updateUsersTable() {
          $('#usersTable').bootstrapTable({
            columns: [
              {
                field: 'id', title: 'ID', sortable: true, class: 'col-id',
              },
              {
                field: 'username', title: 'Usuário', sortable: true, class: 'col-title',
              },
              {
                field: 'fullname', title: 'Nome completo', sortable: true, editable: true
              },
              { 
                field: 'role', title: 'Cargo', sortable: true, editable: true, 'editable-type': 'select', 'editable-source': "[{'value': 'admin', 'text': 'Admin'}, {'value': 'colaborator', 'text': 'Colaborador'}, {'value': 'client', 'text': 'Cliente'} ]"
              },
              {
                field: 'updatedAt', title: 'Modificado em', sortable: true, class: 'col-timestamp', formatter: 'timestampColFormatter'
              },
              {
                field: 'createdAt', title: 'Criado em', sortable: true, class: 'col-timestamp', formatter: 'timestampColFormatter'
              },
            ],
            data: users,
            sortName: 'id', sortOrder: 'desc'
          });
        }


        /////////////////////
        // Initializations //
        /////////////////////

        Database = BIKE.Database;

        // Admin-only Globals
        let users;


        $.fn.editable.defaults.toggle = 'dblclick';


        
        Database.authenticate(true, () => {
          BIKE.Database.customAPICall('get','user', null, data => {
            users = data;

            $('#heading1').html(`Mostrando ${users.length} usuários`);

            updateUsersTable();
          });

          Database.getAllTags();
          Database.getPlaces( () => {
            updateTable();
            $('#heading2').html(`Mostrando ${markers.length} bicicletários`);
          }, null, null, true);
        });

        
        // 
        // Triggers
        // 

        $('body').on('click', 'tbody tr td', (e) => {
          if (e.target == e.currentTarget) {
            console.log('details');
            $(e.currentTarget).siblings().find('.detail-icon').trigger('click');
          }
        });

        function updateUser(field, row, oldValue, $el) {
          const userId = row.id;
          let dataToUpdate = {};
          dataToUpdate[field] = row[field];

          // Send the updated data through the API
          if (dataToUpdate) {
            console.log('updating:', dataToUpdate);
            BIKE.Database.customAPICall('put', `user/${userId}`, dataToUpdate);
          }
        }

        function updateLocal(field, row, oldValue, $el) {
          const localId = row.id;
          let dataToUpdate = {};

          if (field === 'isPublic') {
            row[field] = row[field]==='1' ? true : false;
          }

          dataToUpdate[field] = row[field];

          // Send the updated data through the API
          if (dataToUpdate) {
            console.log('updating:', dataToUpdate);
            BIKE.Database.customAPICall('put', `local/${localId}`, dataToUpdate);
          }
        }

        $('body').on('editable-save.bs.table', (e, field, row, oldValue, $el) => {
          if (row.username) {
            updateUser(field, row, oldValue, $el);
          } else {
            updateLocal(field, row, oldValue, $el);
          }

        });


      </script>

    </body>

</html>
